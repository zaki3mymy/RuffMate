# アーキテクチャ

## 技術スタック

- **Astro 5.x**: 静的サイトジェネレーター（SSG）
- **React 18+**: Islands Architecture（部分的なハイドレーション）
- **TypeScript**: 型安全な開発
- **TailwindCSS v4**: ユーティリティファーストのCSSフレームワーク（@tailwindcss/viteプラグイン使用）
- **localStorage API**: ブラウザ内のルール設定保存
- **Playwright**: E2Eテスト
- **Vitest**: ユニットテスト
- **GitHub Pages**: デプロイ先

## アーキテクチャ概要

RuffMateは **Astro SSG + Islands Architecture** を採用しています。これにより、高速な初期表示とインタラクティブな機能を両立しています。

### SSG（静的サイトジェネレーション）

ビルド時に936個の全ルールを静的HTMLとして生成します。

**メリット**:
- 初期表示が高速（HTMLがすぐに表示される）
- SEO対策が容易
- サーバー不要（GitHub Pagesで配信可能）

**実装**:
- `src/pages/index.astro`: ビルド時に`rules.json`を読み込み、全ルールをHTMLとして出力
- `src/components/RuleItem.astro`: 各ルールを静的コンポーネントとして生成

### Islands Architecture

必要な部分だけReactでハイドレーション（JavaScriptを有効化）します。

**React Islands（インタラクティブなコンポーネント）**:
- `SearchBar.tsx`: 検索機能（`client:load`）
- `FilterPanel.tsx`: フィルタリング機能（`client:load`）
- `ExportButton.tsx`: エクスポート機能（`client:load`）
- `RuleToggle.tsx`: トグルスイッチ（`client:visible`）

**静的コンポーネント（JavaScriptなし）**:
- `RuleItem.astro`: ルール表示カード
- `Layout.astro`: ベースレイアウト

**ハイドレーション戦略**:
- `client:load`: ページロード時にすぐにハイドレーション（検索・フィルタ）
- `client:visible`: ビューポートに表示されたときにハイドレーション（トグルスイッチ）

### データフロー

```
ビルド時:
uvx ruff rule --all
  ↓ (Markdownパース)
scripts/fetch-rules.ts
  ↓ (JSONとして保存)
src/data/rules.json
  ↓ (Astroビルド)
静的HTML（936ルール全て）

実行時:
ユーザー操作（トグル/検索/フィルタ）
  ↓
React Islands（client:load/visible）
  ↓
localStorage（ruleSettingsStore）
  ↓
DOM操作（フィルタリング）/ エクスポート（TOML生成）
```

## ストレージ戦略

### ruleSettingsStore（2層キャッシュ）

ルール設定は以下の2層構造で管理されます:

1. **In-memoryキャッシュ**: 高速アクセス用のメモリキャッシュ
2. **localStorage**: 永続化ストレージ

**メソッド**:
- `set(ruleCode, enabled)`: 設定を保存（同期）
- `get(ruleCode)`: 設定を取得（非同期、useEffect内で使用）
- `getSync(ruleCode)`: 設定を同期的に取得（キャッシュのみ）
- `getSyncWithStorage(ruleCode)`: 設定を同期的に取得（localStorage含む）
- `clear()`: 全設定をクリア

**バッチ読み込み**:
初期ロード時、localStorageから設定をバッチで読み込みます（50個ずつ、16ms間隔）。これにより、メインスレッドをブロックせずに設定を反映できます。

```typescript
// src/utils/ruleSettings.ts より
const BATCH_SIZE = 50
const BATCH_INTERVAL = 16 // ~60fps

async function loadAllSettings() {
  for (let i = 0; i < allRuleCodes.length; i += BATCH_SIZE) {
    const batch = allRuleCodes.slice(i, i + BATCH_SIZE)
    await new Promise(resolve => requestAnimationFrame(resolve))
    // バッチ処理...
  }
}
```

### フィルタリング（DOM操作ベース）

検索・フィルタ機能は、Reactの再レンダリングではなく、DOM操作で実装しています。

**理由**:
- SSGで生成された936個のルールを再レンダリングするとパフォーマンスが低下
- DOM操作の方が高速（5-10ms）

**実装**:
- `filterRules()`: DOMクエリでルール要素を取得し、`display: none/block`で表示制御
- `matchesCriteria()`: `data-*`属性をチェックしてフィルタ条件にマッチするか判定
- `debounce()`: 検索入力の遅延処理（300ms）

```typescript
// src/utils/filterRules.ts より
export function filterRules(criteria: FilterCriteria): FilterResult {
  const ruleItems = document.querySelectorAll('.rule-item')

  ruleItems.forEach((item) => {
    if (matchesCriteria(item, criteria)) {
      item.style.display = 'block'
    } else {
      item.style.display = 'none'
    }
  })

  // カスタムイベント発行
  window.dispatchEvent(new CustomEvent('filter-complete', { detail: result }))
}
```

## パフォーマンス最適化

### ビルド時の最適化

- **静的HTML生成**: 936個の全ルールをHTMLとして事前生成
- **ルール情報の事前取得**: `scripts/fetch-rules.ts`でビルド時にRuffからルール情報を取得

### 実行時の最適化

- **段階的ハイドレーション**: `client:visible`で画面外のトグルスイッチは遅延ハイドレーション
- **バッチ処理**: localStorage読み込みを50個ずつ、16ms間隔で実行
- **requestAnimationFrame**: メインスレッドをブロックしない設計
- **DOM操作ベースのフィルタリング**: 再レンダリング不要、5-10msで完了
- **debounce**: 検索入力の遅延処理（300ms）

### パフォーマンス指標

Phase 3（SSG + Islands実装後）:
- **トグル操作**: <10ms（Phase 2比97%改善）
- **ページロード**: 3.69秒（初期実装比70%削減）
- **ParseHTML呼び出し**: 22回（初期実装比99.8%削減）
- **初期表示**: 即座（静的HTML）
- **設定反映**: 段階的（ユーザーには自然）

## レスポンシブデザイン

Phase 6で実装されたレスポンシブデザインは、TailwindCSSの条件付きクラスで実装しています。

### ブレークポイント

- **モバイル**: < 768px
- **タブレット**: 768px - 1023px
- **デスクトップ**: 1024px以上

### 主な対応

- **FilterPanel**: モバイルで縦並び、全幅ボタン、折りたたみ機能
- **ExportButton**: モバイルで全幅、モーダル最適化
- **SearchBar**: モバイルで結果カウント非表示
- **Header**: モバイルでコンパクト化

### 実装例

```tsx
// モバイル: 縦並び、タブレット以上: 横並び
<div className="flex flex-col gap-3 md:flex-row md:items-center md:gap-4">

// モバイル: 全幅、タブレット以上: auto幅
<button className="w-full md:w-auto">

// モバイル: 非表示、タブレット以上: 表示
<span className="hidden md:inline">
```

## エクスポート機能

### TOML生成

`generateTomlWithMetadata()`関数で`pyproject.toml`形式の設定を生成します。

**生成内容**:
- コメント（生成日時、URL、Ruffバージョン）
- `[tool.ruff]`セクション
- `select`配列: 有効なルール
- `ignore`配列: 無効なルール

**実装**:
```typescript
// src/utils/exportToml.ts より
export function generateTomlWithMetadata(
  rules: RuffRule[],
  ruffVersion: string
): string {
  const settings = ruleSettingsStore.getSyncWithStorage

  const enabledRules = rules.filter(r => settings(r.code) === true)
  const disabledRules = rules.filter(r => settings(r.code) === false)

  return `# Generated by RuffMate
# ${window.location.href}
# Ruff version: ${ruffVersion}
# Generated at: ${new Date().toISOString()}

[tool.ruff]
select = [${enabledRules.map(r => `\n    "${r.code}",  # ${r.name}`).join('')}
]

ignore = [${disabledRules.map(r => `\n    "${r.code}",  # ${r.name}`).join('')}
]`
}
```

**注意**: `getSyncWithStorage()`を使用することで、画面外（まだハイドレーションされていない）のルールも正しくエクスポートされます。

### クリップボード/ダウンロード

- **クリップボード**: `navigator.clipboard.writeText()`
- **ダウンロード**: Blob URLを生成して`<a>`タグでダウンロード

## テスト戦略

### ユニットテスト（Vitest）

- `tests/filterRules.test.ts`: フィルタリングロジックのテスト
- `tests/fetch-rules.test.ts`: Markdownパース処理のテスト

### E2Eテスト（Playwright）

- フィルタリング動作の検証
- トグル操作の検証
- エクスポート機能の検証

## ビルド・デプロイ

### ビルドプロセス

```bash
npm run fetch-rules  # Ruffからルール情報取得
npm run build        # Astroビルド（静的HTML生成）
```

### GitHub Actions

`.github/workflows/deploy.yml`で自動デプロイを設定:
1. ルール情報取得（`fetch-rules`）
2. ビルド（`npm run build`）
3. GitHub Pagesにデプロイ

### 設定

`astro.config.mjs`:
```javascript
export default defineConfig({
  base: '/RuffMate/',  // GitHub Pagesのサブパス
  integrations: [react()],
  vite: {
    plugins: [tailwindcss()],  // TailwindCSS v4
  },
})
```

## セキュリティ

- **CSP（Content Security Policy）**: GitHub Pagesのデフォルト設定
- **XSS対策**: Astro/Reactのエスケープ処理
- **localStorage**: クライアントサイドのみ、機密情報なし

## 今後の拡張性

- **バックエンド不要**: 全てクライアントサイドで完結
- **オフライン対応**: Service Workerの追加で可能
- **他のフォーマッター対応**: データ取得スクリプトを追加すれば対応可能
- **多言語対応**: i18nライブラリの追加で可能
